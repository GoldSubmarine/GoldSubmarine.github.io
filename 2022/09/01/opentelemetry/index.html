<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="author" content="GoldSubmarine"><title>OpenTelemetry | Submarine</title><link rel="icon" href="https://gcore.jsdelivr.net/gh/goldsubmarine/cdn@master/blog/toucan.png"><link rel="stylesheet" href="https://gcore.jsdelivr.net/gh/goldsubmarine/goldsubmarine.github.io@master/css/style.css"><script src="https://gcore.jsdelivr.net/gh/goldsubmarine/goldsubmarine.github.io@master/js/script.js"></script><script src="https://gcore.jsdelivr.net/gh/goldsubmarine/goldsubmarine.github.io@master/js/tocbot.min.js"></script><meta name="generator" content="Hexo 4.2.1"></head><body><div class="wrapper"><header><nav class="navbar"><div class="container"><div class="navbar-header header-logo"><a href="/">GoldSubmarine&#39;s Blog</a></div><div class="menu navbar-right"><div class="search-box"><div class="search-container"><span class="search-icon"><i class="fa fa-search"></i></span> <input type="input" id="search" autocomplete="off" placeholder="Search..."><div class="search-loader" style="display:none"></div></div><div id="search-result-container"></div></div><a class="menu-item" href="/archives">归档</a> <a class="menu-item" href="/category">分类</a> <a class="menu-item" href="/tag">标签</a> <a class="menu-item" href="/about">关于</a> <input id="switch_default" type="checkbox" class="switch_default"><label for="switch_default" class="toggleBtn"></label></div></div></nav><nav class="navbar-mobile" id="nav-mobile"><div class="container"><div class="navbar-header"><div><a href="/">GoldSubmarine&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a></div><div class="menu-toggle" onclick="mobileBtn()">&#9776; 菜单</div></div><div class="menu" id="mobile-menu"><a class="menu-item" href="/archives">归档</a> <a class="menu-item" href="/category">分类</a> <a class="menu-item" href="/tag">标签</a> <a class="menu-item" href="/about">关于</a></div></div></nav></header><script>var mobileBtn=function(){var e=document.getElementsByClassName("menu-toggle")[0],t=document.getElementById("mobile-menu");e.classList.contains("active")?(e.classList.remove("active"),t.classList.remove("active")):(e.classList.add("active"),t.classList.add("active"))}</script><script src="https://gcore.jsdelivr.net/algoliasearch/3/algoliasearch.min.js"></script><meta property="algolia:search" data-application-id="OMMOIEMSAA" data-api-key="054cc564e105734852905d2e17a0640b" data-index-name="github_blog"><script>const algoliaConfig = document.querySelector('meta[property="algolia:search"]').dataset;
    const client = algoliasearch(algoliaConfig.applicationId, algoliaConfig.apiKey);
    const index = client.initIndex(algoliaConfig.indexName);
    let inputSearch = document.getElementById("search");
    let searchResultContainer = document.getElementById("search-result-container");
    let searchTimer;
    inputSearch.oninput = function(ev) {
        clearTimeout(searchTimer);
        searchTimer = setTimeout(function() {
            searchResultContainer.innerHTML = "";
            searchAlgolia();
        }, 300)
    }
    inputSearch.onblur = function() {
        setTimeout(function() {
            searchResultContainer.innerHTML = "";
        }, 500);
    }
    inputSearch.onfocus = function() {
        if(inputSearch.value) {
            searchAlgolia();
        }
    }
    function searchAlgolia() {
        if(!inputSearch.value || !inputSearch.value.trim()) {
            searchResultContainer.innerHTML = "";
            return;
        }
        document.getElementsByClassName('search-loader')[0].style = 'display: block'
        index.search(inputSearch.value.trim(), function(err, content) {
            if(content.hits.length) {
                console.log(content)
                let resultHtml = '<ul class="search-result">';
                let permalinkList = [];
                content.hits.forEach(hit => {
                    if(!permalinkList.includes(hit.permalink)) {
                        resultHtml += `<li><a href="${hit.permalink.replace(/http:\/\/yoursite\.com/, '')}">${hit.title}</a></li>`
                        permalinkList.push(hit.permalink)
                    }
                });
                resultHtml += '</ul>';
                searchResultContainer.innerHTML = resultHtml;
            } else {
                searchResultContainer.innerHTML = "";
            }
            document.getElementsByClassName('search-loader')[0].style = 'display: none'
        });
    }</script><div class="main"><div class="container"><div class="post-toc"><div class="tocbot-list"></div><div class="tocbot-list-menu"><a class="tocbot-toc-expand" onclick="expand_toc()">全部展开</a> <a onclick="go_top()">回到顶部</a> <a onclick="go_bottom()">前往底部</a></div></div><script>function expand_toc(){var o=document.querySelector(".tocbot-toc-expand");tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:6,orderedList:!1,scrollSmooth:!0}),o.setAttribute("onclick","collapse_toc()"),o.innerHTML="Collapse all"}function collapse_toc(){var o=document.querySelector(".tocbot-toc-expand");tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:1,orderedList:!1,scrollSmooth:!0}),o.setAttribute("onclick","expand_toc()"),o.innerHTML="Expand all"}function go_top(){window.scrollTo(0,0)}function go_bottom(){window.scrollTo(0,document.body.scrollHeight)}document.ready(function(){tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:1,orderedList:!1,scrollSmooth:!0})})</script><article class="post-wrap"><header class="post-header"><h1 class="post-title">OpenTelemetry</h1><div class="post-meta">作者: <a itemprop="author" rel="author" href="/">GoldSubmarine</a> <span class="post-time">日期: <a href="#">2022-09-01&nbsp;&nbsp;20:13:00</a></span> <span class="post-category">分类: <a href="/categories/%E8%BD%AF%E4%BB%B6%E6%8A%80%E6%9C%AF/">软件技术</a></span></div></header><div class="post-content"><h2 id="OpenTelemetry-collector"><a href="#OpenTelemetry-collector" class="headerlink" title="OpenTelemetry collector"></a>OpenTelemetry collector</h2><p><code>OpenTelemetry collector</code> 用于接收数据，通过一系列处理后，导出数据给数据库（比如 <code>prometheus</code>）</p><p>它一般位于应用程序和监控程序中间。</p><p>它是一个 <code>golang</code> 开发的 cli</p><p>从下面链接可以下载该 cli</p><p><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases" target="_blank" rel="noopener">https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases</a></p><p>创建配置文件 <code>collect-config.yml</code></p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line">  <span class="comment">#从下列名字中选择一个：hostmetrics jaeger kafka opencensus prometheus zipkin otlp</span></span><br><span class="line">  <span class="attr">prometheus:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">scrape_configs:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">"example"</span></span><br><span class="line">          <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line">          <span class="attr">metrics_path:</span> <span class="string">"/actuator/prometheus"</span></span><br><span class="line">          <span class="attr">static_configs:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">["localhost:8080"]</span></span><br><span class="line"></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="attr">batch:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">exporters:</span></span><br><span class="line">  <span class="attr">prometheus:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">"localhost:8889"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">pipelines:</span></span><br><span class="line">    <span class="attr">metrics:</span></span><br><span class="line">      <span class="attr">receivers:</span> <span class="string">[prometheus]</span></span><br><span class="line">      <span class="attr">processors:</span> <span class="string">[batch]</span></span><br><span class="line">      <span class="attr">exporters:</span> <span class="string">[prometheus]</span></span><br></pre></td></tr></table></figure><p><img src="https://gcore.jsdelivr.net/gh/goldsubmarine/cdn@master/blog/20220901204419.png" alt="20220901204419"></p><p>使用命令 <code>./otelcol --config=collect-config.yml</code> 启动</p><p>该 cli 启动后，会每隔 5 秒，从 <code>localhost:8080/actuator/prometheus</code> 路径<strong>拉取</strong> <code>prometheus</code> 格式的 metric，然后交给 <code>processors.batch</code> 处理加工数据，最后导出成 <code>prometheus</code> 的格式，挂载端点为 <code>localhost:8889</code>，访问 <code>http://localhost:8889/metrics</code> 可以看到该端点输出了 <code>prometheus</code> 格式的数据，最后在 <code>prometheus</code> 上配置，从该端点定时拉取数据即可。</p><h2 id="Opentelemetry-collector-contrib"><a href="#Opentelemetry-collector-contrib" class="headerlink" title="Opentelemetry collector contrib"></a>Opentelemetry collector contrib</h2><p><a href="https://github.com/open-telemetry/opentelemetry-collector-contrib" target="_blank" rel="noopener">https://github.com/open-telemetry/opentelemetry-collector-contrib</a></p><p>除了标准的 cli 之外，官方还有一个标准 cli 的补充。标准 cli 只提供了简单的几个 receiver,exporter，而 contrib 版本提供了更多对不同框架的支持。打开上述链接，比如查看 <code>exporter/lokiexporter</code>，它提供了对 loki 的支持</p><h2 id="OpenTelemetry-Java-instrumentation-agent"><a href="#OpenTelemetry-Java-instrumentation-agent" class="headerlink" title="OpenTelemetry Java instrumentation agent"></a>OpenTelemetry Java instrumentation agent</h2><p><img src="https://gcore.jsdelivr.net/gh/goldsubmarine/cdn@master/blog/20220901204516.png" alt="20220901204516"></p><p>除了主动从 url 拉取数据，<code>OpenTelemetry collector</code>还支持应用端主动推送数据。</p><p>对于一个 java 程序，<code>OpenTelemetry</code> 官方提供了 <code>java agent</code> 可以对一个应用进行插桩，<code>java agent</code> 获取到指标后，主动推送给 <code>OpenTelemetry collector</code>。</p><p>首先修改 <code>collect-config.yml</code> 文件</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">receivers:</span></span><br><span class="line">  <span class="attr">otlp:</span></span><br><span class="line">    <span class="attr">protocols:</span></span><br><span class="line">      <span class="attr">grpc:</span></span><br><span class="line">        <span class="attr">endpoint:</span> <span class="string">"localhost:4317"</span></span><br><span class="line">        <span class="comment"># cors:</span></span><br><span class="line">        <span class="comment">#   allowed_origins:</span></span><br><span class="line">        <span class="comment">#     - http://test.com</span></span><br><span class="line">        <span class="comment">#     # Origins can have wildcards with *, use * by itself to match any origin.</span></span><br><span class="line">        <span class="comment">#     - https://*.example.com</span></span><br><span class="line">        <span class="comment">#   allowed_headers:</span></span><br><span class="line">        <span class="comment">#     - Example-Header</span></span><br><span class="line">        <span class="comment">#   max_age: 7200</span></span><br><span class="line">      <span class="attr">http:</span></span><br><span class="line">        <span class="attr">endpoint:</span> <span class="string">"localhost:4318"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">processors:</span></span><br><span class="line">  <span class="attr">batch:</span></span><br><span class="line"></span><br><span class="line"><span class="attr">exporters:</span></span><br><span class="line">  <span class="attr">prometheus:</span></span><br><span class="line">    <span class="attr">endpoint:</span> <span class="string">"localhost:8889"</span></span><br><span class="line"></span><br><span class="line"><span class="attr">service:</span></span><br><span class="line">  <span class="attr">pipelines:</span></span><br><span class="line">    <span class="attr">metrics:</span></span><br><span class="line">      <span class="attr">receivers:</span> <span class="string">[otlp]</span></span><br><span class="line">      <span class="attr">processors:</span> <span class="string">[batch]</span></span><br><span class="line">      <span class="attr">exporters:</span> <span class="string">[prometheus]</span></span><br></pre></td></tr></table></figure><p>使用命令 <code>./otelcol --config=collect-config.yml</code> 启动</p><p><code>java agent</code> 用来收集信息，它可以直接帮你的应用暴露 metric 端口，也可以主动推送 数据 给 <code>OpenTelemetry collector</code></p><p>然后我们开始下载 java agent，下载链接如下</p><p><a href="https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases" target="_blank" rel="noopener">https://github.com/open-telemetry/opentelemetry-java-instrumentation/releases</a></p><p>用以下命令启动提前准备好的 jar 包，<code>java -javaagent:./opentelemetry-javaagent.jar -jar ./bootJar.jar</code></p><p>启动后，agent 就会自动捕获信息，推送到 <code>localhost:4317</code>，打开 <code>http://localhost:8889/metrics</code> 可以看到 collector 已经获取到数据，并准备好了 prometheus 的 endpoint 端口</p><p>如果推送时报了以下错误</p><blockquote><p>ERROR io.opentelemetry.exporter.internal.grpc.OkHttpGrpcExporter - Failed to export spans. Server responded with UNIMPLEMENTED. This usually means that your collector is not configured with an otlp receiver in the “pipelines” section of the configuration. If export is not desired and you are using OpenTelemetry autoconfiguration or the javaagent, disable export by setting OTEL_TRACES_EXPORTER=none. Full error message: unknown service opentelemetry.proto.collector.trace.v1.TraceService</p></blockquote><p>往往是 collector 的配置文件中没有配置 <code>service.pipelines.traces</code>，可以选择直接关闭 trace 的功能即可，启动命令如下：<code>java -javaagent:./opentelemetry-javaagent.jar &quot;-Dotel.traces.exporter=none&quot; -jar .\bootJar.jar</code></p><p>更多 agent 的配置参数可以参考官方文档：<a href="https://opentelemetry.io/docs/instrumentation/java/automatic/agent-config/" target="_blank" rel="noopener">https://opentelemetry.io/docs/instrumentation/java/automatic/agent-config/</a></p><h3 id="tip"><a href="#tip" class="headerlink" title="tip"></a>tip</h3><p>java agent 支持直接导出成 <code>prometheus</code> 格式的数据，供监控端拉取，当然可以用 <code>collector</code> 主动拉取的方式获取数据后进行加工处理，也可以不部署 <code>collector</code>，在<code>prometheus</code> 上直接对应用的 metric 进行拉取</p><p>参考文章：</p><ol><li><a href="https://grafana.com/blog/2022/06/23/how-to-send-logs-to-grafana-loki-with-the-opentelemetry-collector-using-fluent-forward-and-filelog-receivers/" target="_blank" rel="noopener">https://grafana.com/blog/2022/06/23/how-to-send-logs-to-grafana-loki-with-the-opentelemetry-collector-using-fluent-forward-and-filelog-receivers/</a></li><li><a href="https://grafana.com/blog/2022/05/04/how-to-capture-spring-boot-metrics-with-the-opentelemetry-java-instrumentation-agent/" target="_blank" rel="noopener">https://grafana.com/blog/2022/05/04/how-to-capture-spring-boot-metrics-with-the-opentelemetry-java-instrumentation-agent/</a></li></ol></div><section class="post-copyright"><p class="copyright-item"><span>作者:</span> <span>GoldSubmarine</span></p><p class="copyright-item"><span>原文地址:</span> <span><a href="https://goldsubmarine.github.io/2022/09/01/opentelemetry/">https://goldsubmarine.github.io/2022/09/01/opentelemetry/</a></span></p><p class="copyright-item"><span>许可:</span> <span>Copyright (c) 2022 <a href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC-BY-NC-4.0</a> LICENSE</span></p></section><section class="post-tags"><div><span>Tag(s):</span> <span class="tag"><a href="/tags/OpenTelemetry/"># OpenTelemetry</a></span></div><div><a href="javascript:window.history.back();">back</a> <span>·</span> <a href="/">home</a></div></section><section class="post-nav"><a class="next" rel="next" href="/2022/07/03/prometheus-%E7%9B%91%E6%8E%A7/">Prometheus 监控</a></section></article></div><div id="gitalk-container"></div><link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/gitalk@1.5.2/dist/gitalk.css"><script src="https://gcore.jsdelivr.net/npm/gitalk@1.5.2/dist/gitalk.min.js"></script><script src="https://gcore.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script src="https://gcore.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js"></script><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
        clientID: '4eeae5fd36daf5647141',
        clientSecret: 'be865c2d10e4a71994120646ff80bdaef656b9be',
        repo: 'GoldSubmarine.github.io',
        owner: 'GoldSubmarine',
        admin: 'GoldSubmarine',
        id: md5(location.pathname),
        labels: 'Gitalk'.split(',').filter(l => l),
        perPage: 10,
        pagerDirection: 'last',
        createIssueManually: true,
        distractionFreeMode: false
      })
      gitalk.render('gitalk-container')

      mediumZoom(document.querySelectorAll("img"), { background: '#212530' })</script><link rel="stylesheet" href="https://gcore.jsdelivr.net/npm/aplayer/dist/APlayer.min.css"><script src="https://gcore.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script><script src="https://gcore.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script></div><footer id="footer" class="footer"><div class="copyright"><span>© GoldSubmarine | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span></div></footer></div></body></html>