---
title: JVM 笔记
date: 2019-11-26 22:40:45
tags: java
---

## Java 内存区域

### 程序计数器

每个线程私有的一块较小的内存空间。通过改变计数器的值来选取下一个需要执行的字节码指令，分支、循环、跳转、异常处理、线程恢复都依赖于它。

### 虚拟机栈

线程私有的一块内存，用于描述方法执行的内存模型：每个方法在执行的而同时都会创建一个栈帧用于存储局部变量表、操作数栈、动态链接、方法出口等信息。当线程请求的栈深度大于虚拟机允许的深度时，抛出 StackOverflowError

### 堆

Java 虚拟机所管理的内存中最大的一块区域。所有线程共享 这块堆内存。所有的实例对象都存放在此

### 方法区

线程共享的一块区域，存储已被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。Hotspot 使用永久代来实现方法区，但其他虚拟机并未这么做，所以他们不等价

### 运行时常量池

它是方法区的一部分。Class 文件除了有类的版本、字段、方法、接口等描述信息外，还有一项信息时常量池。运行期间也可将新的常量放入池中，例如 String 类的 intern()方法

## HotSpot 虚拟机对象探秘

### 对象创建

虚拟机遇到一条 new 指令时，首先检查能否在常量池中定位到这个类的符号引用，并且检查这个符号引用代表的类是否已被加载、解析和初始化过，如果没有则先执行类加载。

类加载通过后，对象所需内存的大小在类加载完成后便可确定，虚拟机将为新生对象分配内存。java 堆中的内存可以是绝对规整的，也可以是零散的，取决于 GC 是否带有压缩整理的功能，不通的虚拟机表现不通。如果是规整的，只需分配内存的指针移动一段与对象大小相等的内存即可，这种方法叫“指针碰撞”（因多线程，所以采用 CAS 移动指针，保证原子性）。如果是零散的，那么虚拟机维护了一个表用于记录哪些内存块是可用的，这种分配方式被称为“空闲列表”。

对象创建后，虚拟机要对对象进行必要的设置，例如这个对象属于哪个类的实例、如何找到类的元数据信息、哈希码、GC 分代年龄等，这些信息存放在对象的对象头中。

上面的工作完成后，对象已经产生了，所有字段都还为零，最后执行\<init>方法，把对象按照程序员的医院进行初始化，这样才得到一个真正可用的对象。

### 对象的内存布局

对象在内存中存储的布局可以分为：对象头、实例数据和对齐填充。

对象头包括两部分信息，一部分是用于存储对象自身的运行时数据，如哈希码、GC 分代年龄、锁状态标志、线程持有的锁、偏向线程 ID、偏向时间戳等。另一部分是类型指针，及对象指向它的类元数据的指针，虚拟机通过这个指针来确定这个对象是哪个类的实例。如果是数组，对象头中还有一块用于记录数组长度的数据。

### OutOfMemeoryError 异常实战

#### Java 堆溢出

除了程序计数器外，虚拟机中其他几个运行时区域都可能发生 OutOfMemeoryError 异常，下文简称 OOM

```bash
VM Args: -Xms20m -Xmx20m -XX:+HeapDumpOnOutOfMemoryError
```

上述代码限制 java 堆的大小为 20M（最小值-Xms 最大值-Xmx），通过参数`-XX:+HeapDumpOnOutOfMemoryError`可以让虚拟机在出现内存溢出异常时 Dumo 出当前内存对转储快照，以便事后进行分析。

#### 虚拟机栈和本地方法栈溢出

使用`-Xss`设定栈内存容量大小，例：`VM Args: -Xss2M`

递归过多或线程太多，大量的局部变量可能导致栈溢出。再不能减少线程数的情况下，只能通过减少最大堆和减少栈容量来换取更多的线程。

#### 方法区和运行时常量池溢出

运行时常量池是方法区的一部分，JDK1.7 开始，HotSpot 开始将方法区移出“永久代”。

在 JDK1.6 及之前的版本中，可以通过设置`-XX:PermSize`和`-XX:MaxPermSize`限制方法区的大小，从而间接的限制常量池的容量。例：`VM Args: -XX:PermSize=10M -XX:MaxPermSize=10M`

方法区用于存放 Class 相关的信息，如雷鸣、访问修饰符、常量池、字段描述、方法描述等。测试方法是产生大量的类去填满方法区直到溢出，但是实验比较麻烦，可以使用 CGLib 直接操作字节码运行时产生大量的动态类。Spring、Hibernate 在对类增强时都会用到 CGLib 这类字节码技术。增强的类越多就需要越大的方法区来保证动态生成的 Class 可以加在到内存中。

#### 本机直接内存溢出

DirectMemory容量可以通过`-XX:MaxDirectMemorySize`指定，如果不指定，则默认与java堆最大值（-Xmx指定）一样，例：`VM Args -Xmx20M -XX:MaxDirectMemorySize=10M`
